function getMarginOrPadding(b,a){return parseInt(b.css(a).replace("px"))}String.prototype.trim=function(){return this.replace(/(^[\\s]*)|([\\s]*$)/g,"")};function getLabel(d,a){if(d.length*2<=a){return d}var e=0;var c="";for(var b=0;b<d.length;b++){if(d.charCodeAt(b)>128){e=e+2;if(e>a){return c.substring(0,c.length-1)+"..."}}else{e=e+1;if(e>a){return c.substring(0,c.length-2)+"..."}}c=c+d.charAt(b)}return c}function getBlocksWidth(){var a=0;$(".metroblock",$("#contentinner")).each(function(){a+=$(this).outerWidth(true)});if(a>0){a-=getMarginOrPadding($(".metroblock"),"marginRight")}return a}function setInnerWidth(){var b=getBlocksWidth();var a=getMarginOrPadding($("#contentinner"),"marginLeft");var c=getMarginOrPadding($("#contentinner"),"marginRight");$("#contentinner").width(b+a+c)}function setBlocksHeight(){var a=$("#content").height();$(".metroblock").height(a)}(function(a){a.fn.jMainScroll=function(b,d){var e={_pos:0,_view:b,_content:d,_ratio:1,_wheelSpeed:40,setDelta:function(f){this.setPosition(this._pos+f)},setPosition:function(k){var j=this._view.width(),g=this._content.width();if(this._bar==null){return}var h=j/(g+0.01);if(h>=1){k=0}else{if(k<0){k=0}else{if(k>g-j){k=g-j}}}this._pos=k;var i=k*h;this._bar.css("left",i+"px");this._content.css("left",-k+"px")},reinitialize:function(h){var j=this._view.width(),g=this._content.width();this._ratio=j/g;if(this._ratio>=1){c.css("width","0px");return e}var f=this._track.width();var i=j/g*f;c.css("width",i+"px");if(h){this._pos=0;this._content.css("left","0px")}else{if(this._pos>=g-j){this._pos=g-j-0.01}}this.setPosition(this._pos)},getPosition:function(){return this._pos}};this.css("margin","0").css("padding","0");var c=a('<div class="main-scroll-bar" style="margin:0;padding:0;"></div>').appendTo(this);c.css("height","100%").css("position","absolute").css("top","0");c.hide();e._bar=c;e._track=this;d.mousewheel(function(i,j,g,f){if(e._bar==null){return}var h=g;if(Math.abs(h)<0.00001){h=-f}if(e._hideTimer){window.clearTimeout(e._hideTimer)}else{e._bar.fadeIn("fast")}e._hideTimer=window.setTimeout(function(){e._bar.fadeOut("fast");e._hideTimer=null},200);e.setDelta(h*e._wheelSpeed);i.preventDefault()});e.reinitialize(true);return e}})(jQuery);(function(c){var b={init:function(d){return this.each(function(){var g=c(this),e=g.data("metroblk");if(!e){var f=new a(g);c(this).data("metroblk",{target:g,obj:f})}})},destroy:function(){},setContentObject:function(d){return this.each(function(){var f=c(this),e=f.data("metroblk");if(e){e.obj.setContentObject(d)}})},rearrange:function(){return this.each(function(){var e=c(this),d=e.data("metroblk");if(d){d.obj.rearrange()}})},setVisibility:function(d,e){return this.each(function(){var g=c(this),f=g.data("metroblk");if(!f){return}if(d){g.show()}c(".metrosubblock",g).each(function(){var h=c(this);setTimeout(function(){if(d==true){h.fadeIn(100)}else{h.fadeOut(100)}},Math.random()*200)});setTimeout(function(){if(!d){g.hide()}if(e){e(g)}},400)})}};c.fn.jMetroBlock=function(d){if(b[d]){return b[d].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof d==="object"||!d){return b.init.apply(this,arguments)}else{c.error("Method "+d+" does not exist on jQuery.jMetroBlock")}}return this};function a(d){this.oWrapper=d;this.title="Unknown";this.options={tileSize:150,tileMargin:10,};function g(m,l){var k=0;for(var j=0;j<l.length;j++){k+=m[l[j]].width}return k}function h(j,i){i.sort(function(k,l){return g(j,l)-g(j,k)});return i}function f(n,o){var j=[];var m=0;for(var k=0;k<n.length;k++){if(j[m]==null){j[m]=[]}j[m].push(k);m=(m+1)%o}return h(n,j)}function e(n,p){if(p<=0){console.error("rowCnt<=0");return[]}var j=[];var o=0;var k=[];for(var m=p-1;m>=0;m--){j[m]=[];k[m]=0}for(var m=0;m<n.length;m++){k[o]+=n[m].width;j[o].push(m);o=k.indexOf(Math.min.apply(Math,k))}return h(n,j)}this.arrangeFunc=e;this.rearrange=function(){if(this._apps==null){return}var s=this.oWrapper;var B=this.options;var j=this._apps;var i=s.innerHeight();var q=Math.floor((i-B.tileMargin)/(B.tileSize+B.tileMargin));var p=this.arrangeFunc(this._apps,q);var r=0;var l=B.tileMargin;for(var A=0;A<p.length;A++){if(p[A].length==0){continue}var z=l+"px 0 0 "+l+"px";var y=0;var t=l;for(var k=0;k<p[A].length;k++){var v=p[A][k];var n=j[v].width;var u=n*B.tileSize+(n-1)*l;var o=c(".metrosubblock:nth-child("+(v+1)+")",s);o.width(u).height(B.tileSize);o.css("top",(l+B.tileSize)*A+l).css("left",t);t+=u+l;y+=n}if(y>r){r=y}}s.width(r*(B.tileSize+l)+l)};this.initialize=function(){this.oWrapper.empty();if(this._apps==null){return}var k=this.oWrapper;var l=this.options;var n=this._apps;k.css("min-height",l.tileSize+l.tileMargin*2);for(var i=0;i<n.length;i++){var o=c('<div class="metrosubblock"></div>').appendTo(k);var m=n[i].width;var j=m*l.tileSize+(m-1)*l.tileMargin;o.width(j).height(l.tileSize);o.addClass(n[i]["style"]);if(n[i].html){o.html(n[i].html)}else{c("<p>"+n[i].name+"</p>").appendTo(o)}o.data("myapp",n[i]);o.mouseenter(function(){c(this).addClass("metrosubblock-over")});o.mouseleave(function(){c(this).removeClass("metrosubblock-over")});if(n[i].onclick){o.click(function(){var p=c(this).data("myapp");if(p&&p.onclick){p.onclick(p)}})}else{o.click(function(){var p=c(this).data("myapp")["url"];if(!p){return false}window.open(p);return false})}}c("img.lazyload",k).each(function(){if(c(this).attr("src")==c(this).attr("data-original")){return}var p=new Image();var q=c(this);p.onload=function(){q.attr("src",q.attr("data-original"))};p.src=c(this).attr("data-original")})};this.setContentObject=function(i){c.each(i,function(j){});this._apps=i;this.initialize();return this};this.setContent=function(i){var j=c.parseJSON(i);this.setContentObject(j)}}})(jQuery);var scrollObj=null;function randomStyle(){return"metroblkcolor"+Math.floor(Math.random()*7)}function refreshMetro(a){setBlocksHeight();$(".metroblock",$("#contentinner")).jMetroBlock("rearrange");setInnerWidth();if(scrollObj){scrollObj.reinitialize(true)}}function genTest(){var f=1+Math.floor(Math.random()*9);var b=["red","grey","orange","green","blue","white","yellow","purple"];var g="[";for(var e=0;e<f;e++){var d='{"name":"A'+e+'", "width":';var a=1+Math.floor(Math.random()*2);var h=Math.floor(Math.random()*b.length);d+=a;d+=",";d+='"color":"'+b[h]+'"';d+="}";if(e!=0){g+=","}g+=d}g+="]";return g}function GetURLParameter(a){var d=window.location.search.substring(1);var c=d.split("&");for(var b=0;b<c.length;b++){var e=c[b].split("=");if(e[0]==a){return e[1]}}}var Bilibili={userinfo:null,PUBLIC_KEY:"248727bcee50fc78c535a32c1a12be4a",state:"START",getLoginURL:function(){return"https://secure.bilibili.tv/login.php?api=http://bilibili.chenyh.heliohost.org/logincb&hash="+this.PUBLIC_KEY+"&ver=2"},channels:{1:{name:"Anime",icon:"images/anime.png"},3:{name:"Music",icon:"images/music.png"},4:{name:"Game",icon:"images/game.png"},5:{name:"Entertainment"},11:{name:"Album",icon:"images/album.png"},33:{name:"Bangumi"},23:{name:"Movie"}},renderList:function(g,e,c,b){var d=this;function a(){if(e.list==null){e.list={}}var p=0;var q=[];$.each(e.list,function(i,l){if(/^\d+$/.test(i)){var t={_ranking:parseInt(i),style:randomStyle(),name:l.title,_aid:l.aid,_bili:l,width:1,url:"http://www.bilibili.tv/video/av"+l.aid+"/"};p+=1;q.push(t)}});q.sort(function(i,l){return i._ranking-l._ranking});for(var r=0;r<p/4;r++){q[r].width=2}for(var r=0;r<p;r++){if(q[r].width==1){var w=Math.floor(Math.random()*2);switch(w){case 0:q[r].style+=" metro-block-content-w1-0";q[r].html=$("<img></img>").addClass("metro-block-content-w1-0 lazyload").attr("data-original",q[r]._bili.pic).attr("src","images/loading150.gif").height(160).width(160).prop("outerHTML");break;case 1:var k=$("<div>").addClass("metro-block-content-w1-1");$("<h3></h3>").text(getLabel(q[r]["name"].trim(),40)).addClass("video-title").appendTo(k);$("<p></p>").text("Play: "+q[r]._bili.play).appendTo(k);var n=q[r]._bili.create;if(n){n=n.split(/\s+/)[0]}else{datastr="--"}$("<p></p>").addClass("video-info").text("Time: "+(q[r]._bili.duration||"--")).appendTo(k);$("<p></p>").addClass("video-info").text("Date: "+n).appendTo(k);q[r].html=k.prop("outerHTML")}}else{if(q[r].width==2){var k=$("<div>").addClass("metro-block-content-w2-0");$("<img>").addClass("metro-block-content-w2-0-pv lazyload").attr("data-original",q[r]._bili.pic).attr("src","images/loading90_70.gif").height(70).width(90).appendTo(k);$("<div>").addClass("metro-block-content-w2-0-title video-title").text(q[r]["name"]).appendTo(k);var m=$("<div>").addClass("metro-block-content-w2-0-info video-info").appendTo(k);$("<div>").addClass("metro-block-content-w2-0-info-sub").text("Time: "+(q[r]._bili.duration||"--")).appendTo(m);$("<div>").addClass("metro-block-content-w2-0-info-sub").text("Play: "+q[r]._bili.play).appendTo(m);$("<div>").addClass("metro-block-content-w2-0-desc").text(q[r]._bili.description).appendTo(k);q[r].html=k.prop("outerHTML")}}}if(!e.name){e.name="?"}var s="";var v="metro-title-block-text";if(g>0&&d.channels[g]&&d.channels[g]["icon"]){s='<img  class="metro-title-block-logo-child" src="'+d.channels[g].icon+'"></img><div class="metro-title-block-logo-child-text">'+e.name+"</div>";v="metro-title-block-logo"}else{var j=e.name||"?";s='<div class="metro-title-block-text-child">'+j.substr(0,5)+"</div>"}var k={_ranking:9999,style:randomStyle()+" "+v,name:e.name,html:s,width:2,onclick:function(i){}};q.push(k);function u(o){for(var t,l,y=o.length;y;t=parseInt(Math.random()*y),l=o[--y],o[y]=o[t],o[t]=l){}return o}return u(q)}if(!e){console.error("data empty");return}e._tid=g;var f=$('<div class="metroblock"></div>');f.jMetroBlock();f.data("biliObj",e);f.jMetroBlock("setContentObject",a());var h=null;if(!c){c="#contentinner"}if(!h){if(b=="front"){f.prependTo(c)}else{f.appendTo(c)}}else{f.insertBefore(h)}f.height($("#content").height());f.jMetroBlock("rearrange");setInnerWidth();if(scrollObj){scrollObj.reinitialize(false)}},crossDomainJSON:function(b,a){$.ajax({url:b,type:"GET",success:function(c){if(!c.data){return}var e=null;try{e=$.parseJSON(c.data.query.results.body.p)}catch(d){$.error(d);return}if(a){a(e)}}})},fetchList:function(f,c,e,a){var b="http://api.bilibili.tv/list?type=json&tid="+f;if(c){b+="&pagesize="+c}if(e){b+="&page="+e}if(a){b+="&order="+a}var d=this;this.crossDomainJSON(b,function(g){d.renderList(f,g,Bilibili.currentStartNode)})},startFetchHotList:function(){var a=this;$.each(this.channels,function(c,d){var b=12+Math.floor(Math.random()*12);a.fetchList(c,b,1,"default")})},stateTable:{START:{SEARCH:function(){$("#hide-start").data("currentpos",scrollObj.getPosition());$(".metroblock",$("#contentinner")).jMetroBlock("setVisibility",false,function(){Bilibili.currentStartNode="#hide-start";$(".metroblock",$("#contentinner")).detach().prependTo("#hide-start");scrollObj.reinitialize(true)});$("#searchbox").show()}},SEARCH:{START:function(){Bilibili.searchCancelled=true;$("#contentinner").empty();$(".metroblock",$("#hide-start")).detach().prependTo("#contentinner");refreshMetro();Bilibili.currentStartNode="#contentinner";scrollObj.setPosition($("#hide-start").data("currentpos"));$(".metroblock",$("#contentinner")).jMetroBlock("setVisibility",true,function(){});$("#searchbox").hide()}},},transferTo:function(a){if(this.state==a){return}if(this.stateTable[this.state][a]){this.stateTable[this.state][a]();var b=this;$("#title").fadeOut(100,function(){b.state=a;var c=a.toLowerCase();c=c.substr(0,1).toUpperCase()+c.substr(1);$(this).text(c).fadeIn(100)})}else{console.log("illegal transfer")}return},getState:function(){return this.state},toggleSearch:function(){if(this.state=="START"){this.transferTo("SEARCH")}else{this.transferTo("START")}},searchCancelled:false,startSearch:function(a){if(!a){return}$("#title").text("Search...");this.searchCancelled=false;var b=this;this.crossDomainJSON("http://api.bilibili.tv/search?keyword="+a,function(c){if(b.searchCancelled){return}$("#title").text("Search");if(!c||c.code!=0){c.name="Fail";b.renderList(0,c,"#contentinner","front")}else{c.list=c.result;c.name="Find";b.renderList(0,c,"#contentinner","front")}})},init:function(){var a=this;this.currentStartNode="#contentinner";$("#title").text("Start");$("#searchbox").hide();$("#search-text").keypress(function(b){if(b.which==13){a.startSearch($("#search-text").val());$("#search-btn").focus();b.preventDefault()}});$("#search-btn").click(function(){a.startSearch($("#search-text").val())});$("#search-text").focus(function(){$(this).select()});$("#search-text").mouseup(function(b){b.preventDefault()})},};$(document).ready(function(){Bilibili.init();setBlocksHeight();setInnerWidth();scrollObj=$("#main-scroll").jMainScroll($("#content"),$("#contentinner"));$(window).resize(function(){refreshMetro()});$("#title").click(function(){Bilibili.toggleSearch()});$("#username").click(function(){window.location.replace(Bilibili.getLoginURL())});$.getJSON("/userinfo.json",function(a){if(!a.mid){$("#userinfo").text("Offline")}else{Bilibili.userinfo=a;$("#username").unbind("click").text(a.uname);$("#user-image").attr("src",a.face);$("#userinfo").text("Rank:"+a.rank+" MID:"+a.mid)}});Bilibili.startFetchHotList()});